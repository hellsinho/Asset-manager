<!--dashboardControle.html -->

{% extends 'baseTailWindCss.html' %}

{% block title %}Dashboard de Controle - Ativos{% endblock %}

{% block content %}
<nav class="py-6 px-6 flex justify-between items-center border-b border-gray-200 bg-blue-600">
    <a href="/dashboard" class="text-6xl font-bold text-white px-10 flex items-center">
        <span class="mr-2">&#8592;</span>
    </a>
    <a href="#" class="text-6xl font-bold text-white px-10 flex items-center">
        <span>Dashboard de Controle</span>
    </a>
    <!-- Link para a página de histórico -->
    <a href="/dashboard/controlar/historico" class="text-2xl font-bold text-white px-6">Histórico</a>
</nav>
<div class="px-6 py-6">
    <div class="grid grid-cols-4 gap-6">
        <!-- Exemplo de ativo 1 - Ajuste de pH -->
        <div class="bg-blue-200 aspect-square shadow-inner bg-gray-100 rounded-lg w-full border-2 shadow-lg">
            <div class="w-1/3 bg-green-400 py-2 rounded-lg mt-2 ml-2"></div>
            <div class="mx-3 mt-3">
                <h3 class="font-bold text-2xl">Tanque de Ajuste de pH</h3>
                <div class="grid grid-rows-4 text-xl mt-5 font-medium gap-y-2">
                    <span id="ajuste-pH-status" data-nome="Tanque de Ajuste de pH" class="status">Status: Desativado</span>
                    <span>Localização: Sala de tratamento</span>
                    <span>Etapa: Ajuste de pH</span>
                </div>
                <!-- Botão de ativar/desativar -->
                <div class="flex justify-center items-center mt-2">
                    <button id="btn-ajuste-pH" class="bg-green-500 text-white py-2 px-4 rounded-full" onclick="toggleStatus('Tanque de Ajuste de pH', this)">Ativar</button>
                </div>
            </div>
        </div>
        <!-- Fim do exemplo de ativo 1 -->

        <!-- Exemplo de ativo 2 - Precipitação -->
        <div class="bg-blue-200 aspect-square shadow-inner bg-gray-100 rounded-lg w-full border-2 shadow-lg">
            <div class="w-1/3 bg-red-400 py-2 rounded-lg mt-2 ml-2"></div>
            <div class="mx-3 mt-3">
                <h3 class="font-bold text-2xl">Unidade de Precipitação</h3>
                <div class="grid grid-rows-4 text-xl mt-5 font-medium gap-y-2">
                    <span id="precipitacao-status" data-nome="Unidade de Precipitação" class="status">Status: Desativado</span>
                    <span>Localização: Área de tratamento</span>
                    <span>Etapa: Precipitação</span>
                </div>
                <!-- Botão de ativar/desativar -->
                <div class="flex justify-center items-center mt-2">
                    <button id="btn-precipitacao" class="bg-green-500 text-white py-2 px-4 rounded-full" onclick="toggleStatus('Unidade de Precipitação', this)">Ativar</button>
                </div>
            </div>
        </div>
        <!-- Fim do exemplo de ativo 2 -->

        <!-- Exemplo de ativo 3 - Coagulação -->
        <div class="bg-blue-200 aspect-square shadow-inner bg-gray-100 rounded-lg w-full border-2 shadow-lg">
            <div class="w-1/3 bg-yellow-400 py-2 rounded-lg mt-2 ml-2"></div>
            <div class="mx-3 mt-3">
                <h3 class="font-bold text-2xl">Sistema de Coagulação</h3>
                <div class="grid grid-rows-4 text-xl mt-5 font-medium gap-y-2">
                    <span id="coagulacao-status" data-nome="Sistema de Coagulação" class="status">Status: Desativado</span>
                    <span>Localização: Central de tratamento</span>
                    <span>Etapa: Coagulação</span>
                </div>
                <!-- Botão de ativar/desativar -->
                <div class="flex justify-center items-center mt-2">
                    <button id="btn-coagulacao" class="bg-green-500 text-white py-2 px-4 rounded-full" onclick="toggleStatus('Sistema de Coagulação', this)">Ativar</button>
                </div>
            </div>
        </div>
        <!-- Fim do exemplo de ativo 3 -->

        <!-- Exemplo de ativo 4 - Floculação -->
        <div class="bg-blue-200 aspect-square shadow-inner bg-gray-100 rounded-lg w-full border-2 shadow-lg">
            <div class="w-1/3 bg-purple-400 py-2 rounded-lg mt-2 ml-2"></div>
            <div class="mx-3 mt-3">
                <h3 class="font-bold text-2xl">Unidade de Floculação</h3>
                <div class="grid grid-rows-4 text-xl mt-5 font-medium gap-y-2">
                    <span id="floculacao-status" data-nome="Unidade de Floculação" class="status">Status: Desativado</span>
                    <span>Localização: Setor de tratamento</span>
                    <span>Etapa: Floculação</span>
                </div>
                <!-- Botão de ativar/desativar -->
                <div class="flex justify-center items-center mt-2">
                    <button id="btn-floculacao" class="bg-green-500 text-white py-2 px-4 rounded-full" onclick="toggleStatus('Unidade de Floculação', this)">Ativar</button>
                </div>
            </div>
        </div>
        <!-- Fim do exemplo de ativo 4 -->
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        function toggleStatus(ativoNome, button) {
            const statusSpan = document.getElementById(`${ativoNome}-status`);
            const csrfToken = "{{ csrf_token }}";  // Certifique-se de que o token CSRF esteja disponível na página

            // Verifique o texto do botão para determinar a ação
            const acao = button.innerText === 'Ativar' ? 'Ativar' : 'Desativar';

            // Desabilite o botão para evitar cliques duplicados durante a solicitação AJAX
            button.disabled = true;

            // Realize a solicitação AJAX para atualizar o status
            fetch(`/dashboard/controlar/registra_historico/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ativo=${ativoNome}&acao=${acao}`,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // A solicitação foi bem-sucedida
                        if (acao === 'Ativar') {
                            button.classList.remove('bg-green-500');
                            button.classList.add('bg-red-500');
                            button.innerText = 'Desativar';
                            if (statusSpan) {
                                statusSpan.innerText = 'Status: Ativado';
                            }
                        } else {
                            button.classList.remove('bg-red-500');
                            button.classList.add('bg-green-500');
                            button.innerText = 'Ativar';
                            if (statusSpan) {
                                statusSpan.innerText = 'Status: Desativado';
                            }
                        }

                        // Exemplo de mensagem de confirmação
                        Swal.fire(
                            'Sucesso!',
                            `Ação realizada com sucesso.`,
                            'success'
                        );
                    } else if (data.error) {
                        // Houve um erro na solicitação AJAX
                        Swal.fire(
                            'Erro!',
                            `Erro ao realizar a ação: ${data.error}`,
                            'error'
                        );
                    }
                })
                .catch(error => {
                    // Erro de rede ou falha na solicitação
                    Swal.fire(
                        'Erro!',
                        `Ocorreu um erro na solicitação: ${error}`,
                        'error'
                    );
                })
                .finally(() => {
                    // Reabilite o botão após a conclusão da solicitação AJAX
                    button.disabled = false;
                });
        }

        // Adicione este código para associar os eventos de clique aos botões
        document.getElementById("btn-ajuste-pH").addEventListener("click", function () {
            toggleStatus("TanqueAjustePH", this);
        });
        document.getElementById("btn-precipitacao").addEventListener("click", function () {
            toggleStatus("UnidadePrecipitacao", this);
        });
        document.getElementById("btn-coagulacao").addEventListener("click", function () {
            toggleStatus("SistemaCoagulacao", this);
        });
        document.getElementById("btn-floculacao").addEventListener("click", function () {
            toggleStatus("UnidadeFloculacao", this);
        });
    });
</script>

{% endblock %}
